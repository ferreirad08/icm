<!DOCTYPE html>

<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
      }

      table[name="Header"] {
        width: 100%;
        height: 50px;
        background-color: #fff;
        color: #151b54;
        box-shadow: 0px 2px 2px -1px grey;
        position: fixed;
        top: 0%;
        left: 0%;
      }

      table[name="Header"] td {
        font-size: 15px;
        font-weight: bold;
        border: none;
        width: calc(100% / 3);
        text-align: center;
        padding: 8px;
      }

      label {
        width: 346px;
        margin-left: calc(50% - 173px);
        font-size: 15px;
        color: #151b54;
        height: 30px;
        padding-left: 2px;
      }

      .info {
        font-size: 10px;
        color: #151b54;
        border-radius: 4px;
        box-shadow: -1px 1px 4px 0px grey;
        width: 343px;
        margin-left: calc(50% - 175px);
        padding-top: 7px;
        padding-bottom: 7px;
        padding-left: 7px;
      }

      .registerLink {
        color: blue;
        text-decoration: underline;
      }

      .removeLink {
        color: #b12d33;
        text-decoration: underline;
      }

      h1 {
        width: 100%;
        text-align: center;
        color: #151b54;
      }

      tr:nth-child(even) {
        background-color: #cccccc;
      }

      th {
        background-color: #151b54;
        color: #fff;
      }

      th,
      td {
        padding: 8px;
        text-align: center;
        font-size: 13px;
      }

      table[name="List"] {
        border-collapse: collapse;
        border-radius: 4px;
        overflow: hidden;
        width: calc(346px + 4px);
        margin-left: calc(50% - 175px);
        box-shadow: -1px 1px 4px 0px grey;
      }

      button:disabled {
        background-color: #ccc;
        color: #666;
      }

      input[type="button"],
      button {
        background-color: #151b54;
        color: #ffffff;
        border: none;
        width: calc(346px + 4px);
        margin-left: calc(50% - 175px);
        height: 40px;
        border-radius: 40px;
        font-weight: bold;
      }

      #dell:disabled {
        color: #666;
        border: 2px solid #ccc;
      }

      #dell {
        background-color: #fff;
        color: #b12d33;
        border: 2px solid #b12d33;
      }

      .meu-confirmar {
        width: 145px;
        border-radius: 20px !important;
        background-color: #151b54;
        color: white;
      }

      .meu-cancelar {
        width: 145px;
        border-radius: 20px !important;
        background-color: white;
        color: #151b54;
        border: 2px solid #151b54;
      }

      .meu-input-estilizado:focus {
        outline: none;
        border-bottom: 2px solid #151b54;
        border-top: none;
        border-left: none;
        border-right: none;
      }

      .meu-input-estilizado {
        border-radius: 0px;
        border-bottom: 1px solid gray;
        border-top: none;
        border-left: none;
        border-right: none;
      }

      #tb-options {
        width: calc(346px + 4px);
        margin-left: calc(50% - 175px);
      }

      #tb-options button {
        width: 45px;
        height: 45px;
        border-radius: 45px;
        margin-left: calc(50% - 50px);
      }

      #tb-options td {
        width: calc(100% / 3);
        background-color: #fff;
        color: #ccc;
        font-weight: bold;
        padding-top: 1px;
      }

      .icon {
        font-size: 38px;
      }
    </style>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ora칞칚o Ininterrupta</title>
  </head>
  <body>
    <table name="Header">
      <tr>
        <td
          onclick="window.location.href = 'https://ferreirad08.github.io/icm/oracaoininterrupta/'"
        >
          <i class="bi bi-arrow-left-circle icon"></i>
        </td>
        <td colspan="4">Ora칞칚o Ininterrupta</td>
        <td></td>
      </tr>
    </table>

    <br />
    <br />
    <br />
    <br />

    <div class="info">
      Igreja<br /><label></label> <br /><br />
      Motivo<br /><b><label></label></b> <br /><br />
      Per칤odo (primeiro e 칰ltimo dia)<br /><label></label> <br /><br /><br />
      <label></label>
      <br />
      <label></label>
    </div>

    <br />

    <table id="tb-options">
      <tr>
        <td>
          <button id="copyButton" onclick="copyy()" disabled>
            <i class="bi bi-copy"></i>
          </button>
        </td>
        <td>
          <button id="downloadButton" onclick="download()" disabled>
            <i class="bi bi-file-earmark-pdf"></i>
          </button>
        </td>
        <td>
          <button id="dell" onclick="dell()" disabled>
            <i class="bi bi-trash3"></i>
          </button>
        </td>
      </tr>
      <tr>
        <td id="optLabel-1">Copiar link</td>
        <td id="optLabel-2">Baixar PDF</td>
        <td id="optLabel-3">Excluir escala</td>
      </tr>
    </table>

    <br />

    <div id="onwer-div" hidden></div>

    <table name="List">
      <thead>
        <tr>
          <th>Hor치rio</th>
          <th>Nome</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td colspan="2" style="color: black">Buscando a lista...</td>
        </tr>
      </tbody>
    </table>
    <br />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      const code = window.location.hash.slice(1);
      const url = `https://api.jsonbin.io/v3/b/${code}`;

      const headers = {
        "Content-Type": "application/json",
        "X-Access-Key":
          "$2a$10$hAT1PQtTWY.vtq5BTEeJruDlB.ULfWMknzape/RRM.Xa.xEpds7rG",
      };
      const storageKey = "oracaoininterruptav3";
      //window.localStorage.removeItem(storageKey);
      let locations = window.localStorage.getItem(storageKey);
      locations = locations === null ? {} : JSON.parse(locations);

      const isOnwer = window.location.href in locations;

      function getMessage() {
        const els = document.getElementsByTagName("label");
        return `游닆 *ESCALA DA ORA칂츾O ININTERRUPTA*

_Igreja: ${els[0].innerHTML}_
_Motivo: ${els[1].innerHTML}_
_Per칤odo: ${els[2].innerHTML}_

Para participar do per칤odo de Ora칞칚o Ininterrupta, clique neste link:
${window.location.href}`;
      }

      async function copyy() {
        try {
          await navigator.clipboard.writeText(getMessage());
        } catch (err) {
          console.error("Falha ao copiar: ", err);
        }
      }

      async function download() {
        window.location.href = `https://ferreirad08.github.io/icm/oracaoininterrupta/download#${code}`;
      }

      async function dell() {
        Swal.fire({
          title: `Excluir escala?`,
          text: "Todos os dados ser칚o perdidos!",
          icon: "question",
          showCancelButton: true,
          reverseButtons: true,
          confirmButtonText: "Sim, excluir!",
          cancelButtonText: "Cancelar",
          customClass: {
            confirmButton: "meu-confirmar",
            cancelButton: "meu-cancelar",
          },
        }).then(dellCb);
      }

      async function dellCb(result) {
        if (result.isConfirmed) {
          openLoading("Aguarde...");
          const res = await fetch(url, { method: "DELETE", headers });
          Swal.close();

          if (res.status === 200) {
            delete locations[window.location.href];
            window.localStorage.setItem(storageKey, JSON.stringify(locations));
            await Swal.fire({
              title: "Sucesso!",
              text: "Escala exclu칤da com sucesso!",
              icon: "success",
              customClass: {
                confirmButton: "meu-confirmar",
              },
            });
            window.location.href =
              "https://ferreirad08.github.io/icm/oracaoininterrupta/";
          }
        }
      }

      async function setData(data) {
        await fetch(url, {
          method: "PUT",
          headers,
          body: JSON.stringify(data),
        });
      }

      async function getData() {
        return (await (await fetch(url, { method: "GET", headers })).json())
          .record;
      }

      async function removeRegister(interval, name) {
        Swal.fire({
          title: `Excluir o registro das ${interval} feito por ${name}?`,
          text: "Os dados ser칚o perdidos!",
          icon: "question",
          showCancelButton: true,
          reverseButtons: true,
          confirmButtonText: "Sim, excluir!",
          cancelButtonText: "Cancelar",
          customClass: {
            confirmButton: "meu-confirmar",
            cancelButton: "meu-cancelar",
          },
        }).then(async (result) => {
          if (result.isConfirmed) {
            openLoading("Aguarde...");
            const data = await getData();
            data.timestamp = new Date();
            data.currentList[interval] = null;
            await setData(data);
            await sleep(2000);
            Swal.close();
            window.location.reload();
          }
        });
      }

      async function register(interval) {
        Swal.fire({
          title: interval,
          inputAttributes: {
            placeholder: "Nome",
          },
          text: "Insira o seu nome!",
          input: "text",
          showCancelButton: true,
          reverseButtons: true,
          cancelButtonText: "Cancelar",
          customClass: {
            confirmButton: "meu-confirmar",
            cancelButton: "meu-cancelar",
            input: "meu-input-estilizado",
          },
          inputValidator: (value) => {
            if (value.trim() === "") {
              return "O nome n칚o pode ser vazio!";
            }
            if (value.trim().length > 32) {
              return "Entre com no m치ximo 32 caracteres!";
            }
          },
        }).then((result) => {
          if (result.value) {
            registerCb(result.value.trim(), interval);
          }
        });
      }

      async function registerCb(name, interval) {
        openLoading("Aguarde...");
        const data0 = await getData();

        if (data0.currentList[interval]) {
          Swal.close();
          Swal.fire({
            title: "Aviso!",
            text: `Desculpe, o hor치rio das ${interval} n칚o est치 mais dispon칤vel!`,
            icon: "warning",
            customClass: {
              confirmButton: "meu-confirmar",
            },
          });
          await initHeader(data0);
          return populateTable(data0.currentList);
        }

        data0.timestamp = new Date();
        data0.currentList[interval] = name;

        await setData(data0);
        await sleep(2000);

        const data1 = await getData();
        Swal.close();

        if (data1.currentList[interval] !== data0.currentList[interval]) {
          let message = "N칚o foi poss칤vel concluir. Tente novamente!";
          if (data1.currentList[interval])
            message = `Desculpe, o hor치rio das ${interval} n칚o est치 mais dispon칤vel!`;

          Swal.fire({
            title: "Aviso",
            text: message,
            icon: "warning",
            customClass: {
              confirmButton: "meu-confirmar",
            },
          });
        } else {
          Swal.fire({
            title: "Sucesso!",
            text: "Participa칞칚o registrada com sucesso!",
            icon: "success",
            customClass: {
              confirmButton: "meu-confirmar",
            },
          });
          // window.alert("Participa칞칚o registrada com sucesso!");
        }

        await initHeader(data1);
        populateTable(data1.currentList);
      }

      function populateTable(currentList) {
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        for (const interval in currentList) {
          const row = tbody.insertRow();
          row.insertCell().innerHTML = interval;

          const cell = row.insertCell();

          if (currentList[interval]) {
            if (isOnwer) {
              cell.innerHTML = `<a class='removeLink'>${currentList[interval]}</a>`;
              cell.setAttribute(
                "onclick",
                `removeRegister("${interval}", "${currentList[interval]}")`
              );
            } else {
              cell.innerHTML = currentList[interval];
            }
          } else {
            cell.innerHTML =
              "<a class='registerLink'>Clique para selecionar!</a>";
            cell.setAttribute("onclick", `register("${interval}")`);
          }
        }
      }

      function openLoading(message) {
        Swal.fire({
          title: message,
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function initHeader(data) {
        const els = document.getElementsByTagName("label");
        els[0].innerHTML = data.igreja;
        els[1].innerHTML = data.motivo;
        els[2].innerHTML =
          data.date0.split("-").reverse().join("/") +
          " - " +
          data.date1.split("-").reverse().join("/");
        els[3].innerHTML =
          "<i class='bi bi-clock-history'></i> 칔ltimo registro: " +
          formatDate(data.timestamp);

        const nullCount = Object.values(data.currentList).filter(
          (v) => v
        ).length;
        const percentage = Math.round((nullCount / 96) * 1000, 3) / 10;

        els[4].innerHTML = `<i class='bi bi-list-check'></i> Hor치rios preenchidos: ${nullCount} de 96 (${percentage}%)`;
      }

      async function main() {
        // await sleep(5000);

        const data = await getData();

        if (!data) {
          await Swal.fire({
            title: "Aviso",
            text: "Escala inexistente!",
            icon: "warning",
            customClass: {
              confirmButton: "meu-confirmar",
            },
          });
          window.location.href =
            "https://ferreirad08.github.io/icm/oracaoininterrupta/";
        }

        await initHeader(data);
        populateTable(data.currentList);

        document.getElementById("copyButton").disabled = false;
        document.getElementById("downloadButton").disabled = !isOnwer;
        document.getElementById("dell").disabled = !isOnwer;

        document.getElementById("optLabel-1").style.color = "#151b54";
        document.getElementById("optLabel-2").style.color = isOnwer ? "#151b54" : "#ccc";
        document.getElementById("optLabel-3").style.color = isOnwer ? "#b12d33" : "#ccc";
        
      }

      function formatDate(isoString) {
        const date = new Date(isoString);
        const dia = String(date.getDate()).padStart(2, "0");
        const mes = String(date.getMonth() + 1).padStart(2, "0");
        const ano = date.getFullYear();
        const hora = String(date.getHours()).padStart(2, "0");
        const min = String(date.getMinutes()).padStart(2, "0");
        const seg = String(date.getSeconds()).padStart(2, "0");
        return `${dia}/${mes}/${ano} ${hora}:${min}:${seg}`;
      }

      main();
    </script>
  </body>
</html>
